<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plantas que Falam - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
/* Reset e Base */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
    color: white;
    min-height: 100vh;
    overflow-x: hidden;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
}

/* Header */
.header {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 1rem 0;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.logo-icon {
    font-size: 2rem;
}

.logo h1 {
    font-size: 1.5rem;
    font-weight: bold;
}

.connection-config {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.esp32-url-input {
    padding: 0.5rem 1rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.3);
    color: white;
    width: 200px;
}

.esp32-url-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.connect-btn {
    padding: 0.5rem 1rem;
    background: #22c55e;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
}

.connect-btn:hover {
    background: #16a34a;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 20px;
    font-size: 0.9rem;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ef4444;
    animation: pulse 2s infinite;
}

.status-dot.online {
    background: #22c55e;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Main Content */
.main-content {
    padding: 2rem 0;
}

/* Status Header */
.status-header {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.status-info h2 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.status-info p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
}

.frequency-display {
    text-align: center;
    padding: 1rem;
    background: linear-gradient(45deg, #22c55e, #16a34a);
    border-radius: 15px;
    min-width: 200px;
}

.frequency-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.frequency-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
}

.plant-status {
    font-size: 1rem;
    font-weight: bold;
}

/* Metrics Grid */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.metric-card {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: transform 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-5px);
}

.metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.metric-title {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: #22c55e;
}

.metric-subtitle {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.chart-header {
    margin-bottom: 1rem;
}

.chart-header h3 {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    color: #22c55e;
}

.chart-header p {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

/* Bands Card */
.bands-card {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 2rem;
}

.bands-header {
    margin-bottom: 1.5rem;
}

.bands-header h3 {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    color: #22c55e;
}

.bands-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.band-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.band-info {
    flex: 1;
}

.band-name {
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.band-range {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
}

.band-value {
    text-align: right;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.band-magnitude {
    font-weight: bold;
    color: #22c55e;
}

.band-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

/* Loading States */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2rem;
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.7);
}

.loading::after {
    content: '';
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid #22c55e;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Error States */
.error {
    text-align: center;
    padding: 2rem;
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 10px;
    border: 1px solid rgba(239, 68, 68, 0.3);
    margin: 1rem 0;
}

/* Settings Panel */
.settings-panel {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 2rem;
}

.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: center;
}

.setting-group label {
    display: block;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    color: rgba(255, 255, 255, 0.8);
}

.setting-group select, 
.setting-group input[type="number"] {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 0.5rem;
    color: white;
    width: 100%;
}

.setting-group select option {
    background: #1a1a1a;
    color: white;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 0 10px;
    }
    
    .header-content {
        flex-direction: column;
        align-items: stretch;
    }
    
    .connection-config {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .esp32-url-input {
        width: 100%;
    }
    
    .status-header {
        flex-direction: column;
        text-align: center;
    }
    
    .frequency-display {
        min-width: auto;
        width: 100%;
    }
    
    .metrics-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .bands-grid {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">🌱</span>
                    <h1>Plantas que Falam</h1>
                </div>
                <div class="connection-config">
                    <input type="text" id="esp32-url" class="esp32-url-input" 
                           placeholder="http://192.168.1.100" 
                           value="http://192.168.1.100">
                    <button id="connect-btn" class="connect-btn">Conectar</button>
                </div>
                <div class="status-indicator">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="connection-status">Desconectado</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Settings Panel -->
            <div class="settings-panel">
                <h3 style="color: #22c55e; margin-bottom: 1rem;">Configurações</h3>
                <div class="settings-grid">
                    <div class="setting-group">
                        <label for="refresh-rate">Taxa de Atualização</label>
                        <select id="refresh-rate">
                            <option value="1000">1 segundo</option>
                            <option value="2000" selected>2 segundos</option>
                            <option value="5000">5 segundos</option>
                            <option value="10000">10 segundos</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label for="max-history">Pontos no Histórico</label>
                        <input type="number" id="max-history" value="20" min="10" max="100">
                    </div>
                    <div class="setting-group">
                        <label>Status da Conexão</label>
                        <div id="esp32-info" style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                            Aguardando conexão...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Header -->
            <div class="status-header">
                <div class="status-info">
                    <h2>Dashboard das Plantas</h2>
                    <p>Monitoramento em tempo real através de sensores piezoelétricos</p>
                </div>
                <div class="frequency-display">
                    <div class="frequency-value" id="dominant-freq">0.0 Hz</div>
                    <div class="frequency-label">Frequência Dominante</div>
                    <div class="plant-status" id="plant-status">Aguardando dados...</div>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Sinal Bruto</span>
                    </div>
                    <div class="metric-value" id="raw-value">0</div>
                    <div class="metric-subtitle">Valor ADC (0-4095)</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Voltagem</span>
                    </div>
                    <div class="metric-value" id="voltage">0.00 V</div>
                    <div class="metric-subtitle">Tensão do sensor</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Magnitude Dominante</span>
                    </div>
                    <div class="metric-value" id="dominant-magnitude">0.000</div>
                    <div class="metric-subtitle" id="dominant-magnitude-db">0.0 dB</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Magnitude Média</span>
                    </div>
                    <div class="metric-value" id="average-magnitude">0.000</div>
                    <div class="metric-subtitle">Atividade geral</div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Histórico de Magnitude</h3>
                        <p>Evolução temporal da magnitude dominante</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="magnitudeChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Análise Espectral</h3>
                        <p>Distribuição por bandas de frequência</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="bandsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Frequency Bands List -->
            <div class="bands-card">
                <div class="bands-header">
                    <h3>Análise Detalhada das Bandas de Frequência</h3>
                    <p>Decomposição espectral do sinal captado pelo sensor</p>
                </div>
                <div class="bands-grid" id="bands-list">
                    <!-- Bandas serão preenchidas via JavaScript -->
                </div>
            </div>

            <!-- System Info -->
            <div class="bands-card">
                <div class="bands-header">
                    <h3>Informações do Sistema</h3>
                    <p>Status e estatísticas do ESP32</p>
                </div>
                <div class="settings-grid" id="system-info">
                    <!-- Informações do sistema serão preenchidas via JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <script>
// Configurações da aplicação
const CONFIG = {
    DEFAULT_ESP32_URL: 'http://192.168.1.100',
    DEFAULT_REFRESH_INTERVAL: 2000,
    MAX_CHART_POINTS: 50,
    CONNECTION_TIMEOUT: 5000
};

// Estado global da aplicação
let appState = {
    esp32Url: '',
    refreshInterval: null,
    refreshRate: CONFIG.DEFAULT_REFRESH_INTERVAL,
    isConnected: false,
    charts: {
        magnitude: null,
        bands: null
    },
    lastDataTime: 0,
    errorCount: 0,
    maxHistory: 20
};

// Inicialização da aplicação
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    setupUI();
    loadStoredSettings();
    
    console.log('🌱 Dashboard Plantas que Falam - Aplicação iniciada');
    console.log('Aguardando conexão com ESP32...');
}

// Configuração da interface
function setupUI() {
    // Botão de conexão
    const connectBtn = document.getElementById('connect-btn');
    const urlInput = document.getElementById('esp32-url');
    
    connectBtn.addEventListener('click', function() {
        const url = urlInput.value.trim();
        if (url) {
            connectToESP32(url);
        } else {
            showError('Por favor, insira a URL do ESP32');
        }
    });

    // Enter no campo de URL
    urlInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            connectBtn.click();
        }
    });

    // Configurações
    const refreshRateSelect = document.getElementById('refresh-rate');
    const maxHistoryInput = document.getElementById('max-history');

    refreshRateSelect.addEventListener('change', function() {
        appState.refreshRate = parseInt(this.value);
        saveSettings();
        if (appState.isConnected) {
            restartDataRefresh();
        }
    });

    maxHistoryInput.addEventListener('change', function() {
        appState.maxHistory = parseInt(this.value);
        saveSettings();
    });
}

// Conectar ao ESP32
async function connectToESP32(url) {
    // Normalizar URL
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'http://' + url;
    }
    
    appState.esp32Url = url;
    updateConnectionStatus('connecting');
    
    try {
        // Testar conexão
        const response = await fetch(`${url}/api/sensor/data`, {
            method: 'GET',
            timeout: CONFIG.CONNECTION_TIMEOUT
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Conexão bem-sucedida
        appState.isConnected = true;
        appState.errorCount = 0;
        updateConnectionStatus('online');
        updateESP32Info(data);
        saveSettings();
        
        // Iniciar coleta de dados
        startDataRefresh();
        
        console.log('✅ Conectado ao ESP32:', url);
        
    } catch (error) {
        console.error('❌ Erro ao conectar:', error);
        appState.isConnected = false;
        updateConnectionStatus('offline', error.message);
        showError(`Falha na conexão: ${error.message}`);
    }
}

// Gerenciamento de dados
function startDataRefresh() {
    // Parar intervalo anterior se existir
    if (appState.refreshInterval) {
        clearInterval(appState.refreshInterval);
    }
    
    // Coletar dados imediatamente
    loadSensorData();
    
    // Configurar intervalo
    appState.refreshInterval = setInterval(() => {
        if (appState.isConnected) {
            loadSensorData();
        }
    }, appState.refreshRate);
    
    console.log(`🔄 Atualização iniciada a cada ${appState.refreshRate}ms`);
}

function restartDataRefresh() {
    if (appState.isConnected) {
        startDataRefresh();
        console.log(`🔄 Intervalo alterado para ${appState.refreshRate}ms`);
    }
}

// Carregamento de dados do sensor
async function loadSensorData() {
    if (!appState.isConnected || !appState.esp32Url) return;
    
    try {
        const response = await fetch(`${appState.esp32Url}/api/sensor/data`, {
            method: 'GET',
            cache: 'no-cache'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Resetar contador de erros
        appState.errorCount = 0;
        appState.lastDataTime = Date.now();
        
        // Atualizar dashboard
        updateDashboard(data);
        updateConnectionStatus('online');
        
    } catch (error) {
        appState.errorCount++;
        console.error(`❌ Erro ao carregar dados (tentativa ${appState.errorCount}):`, error);
        
        // Após 3 erros consecutivos, marcar como desconectado
        if (appState.errorCount >= 3) {
            appState.isConnected = false;
            updateConnectionStatus('offline', 'Múltiplos erros de conexão');
            if (appState.refreshInterval) {
                clearInterval(appState.refreshInterval);
                appState.refreshInterval = null;
            }
        }
    }
}

function updateDashboard(data) {
    // Métricas principais
    updateElement('raw-value', data.raw_value);
    updateElement('voltage', `${data.voltage.toFixed(3)} V`);
    updateElement('dominant-magnitude', data.dominant_magnitude.toFixed(3));
    updateElement('dominant-magnitude-db', `${data.dominant_magnitude_db.toFixed(1)} dB`);
    updateElement('average-magnitude', data.average_magnitude.toFixed(3));
    
    // Frequência dominante
    const freqValue = data.dominant_frequency < 1000 
        ? `${data.dominant_frequency.toFixed(1)} Hz`
        : `${(data.dominant_frequency / 1000).toFixed(2)} kHz`;
    updateElement('dominant-freq', freqValue);
    
    // Status da planta
    const plantStatus = data.status === 'online' ? '🟢 Sensor Ativo' : '🔴 Sensor Inativo';
    updateElement('plant-status', plantStatus);
    
    // Gráficos
    if (data.history && data.history.length > 0) {
        updateMagnitudeChart(data.history.slice(-appState.maxHistory));
    }
    
    if (data.bands && data.bands.length > 0) {
        updateBandsChart(data.bands);
        updateBandsList(data.bands);
    }
    
    // Informações do sistema
    if (data.system) {
        updateSystemInfo(data);
    }
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}

function updateConnectionStatus(status, message = '') {
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('connection-status');
    
    if (statusDot && statusText) {
        statusDot.className = `status-dot ${status}`;
        
        switch (status) {
            case 'online':
                statusText.textContent = 'Conectado';
                break;
            case 'offline':
                statusText.textContent = message || 'Desconectado';
                break;
            case 'connecting':
                statusText.textContent = 'Conectando...';
                break;
        }
    }
}

function updateESP32Info(data) {
    const esp32Info = document.getElementById('esp32-info');
    if (esp32Info && data.system) {
        esp32Info.innerHTML = `
            IP: ${appState.esp32Url.replace('http://', '')}<br>
            Uptime: ${Math.floor(data.system.requests_count || 0)} requests<br>
            RSSI: ${data.system.wifi_rssi || 'N/A'} dBm
        `;
    }
}

function updateSystemInfo(data) {
    const systemInfo = document.getElementById('system-info');
    if (!systemInfo || !data.system) return;
    
    systemInfo.innerHTML = `
        <div class="setting-group">
            <label>Memória Livre</label>
            <div style="color: #22c55e;">${data.system.free_heap || 0} bytes</div>
        </div>
        <div class="setting-group">
            <label>Total de Requests</label>
            <div style="color: #22c55e;">${data.system.requests_count || 0}</div>
        </div>
        <div class="setting-group">
            <label>WiFi RSSI</label>
            <div style="color: #22c55e;">${data.system.wifi_rssi || 'N/A'} dBm</div>
        </div>
        <div class="setting-group">
            <label>Device ID</label>
            <div style="color: #22c55e; font-size: 0.8rem;">${data.device_id || 'N/A'}</div>
        </div>
    `;
}

// Gráficos
function updateMagnitudeChart(historyData) {
    const ctx = document.getElementById('magnitudeChart');
    if (!ctx) return;
    
    // Preparar dados
    const labels = historyData.map((item, index) => {
        return new Date(parseInt(item.time)).toLocaleTimeString();
    });
    const magnitudes = historyData.map(item => item.magnitude);
    
    if (appState.charts.magnitude) {
        // Atualizar gráfico existente
        appState.charts.magnitude.data.labels = labels;
        appState.charts.magnitude.data.datasets[0].data = magnitudes;
        appState.charts.magnitude.update('none');
    } else {
        // Criar novo gráfico
        appState.charts.magnitude = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Magnitude',
                    data: magnitudes,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#22c55e',
                    pointBorderColor: '#16a34a',
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: 'white',
                            font: { size: 12 }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { 
                            color: 'rgba(255, 255, 255, 0.7)',
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        display: true,
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                    }
                },
                animation: { duration: 300 }
            }
        });
    }
}

function updateBandsChart(bandsData) {
    const ctx = document.getElementById('bandsChart');
    if (!ctx) return;
    
    const labels = bandsData.map(band => band.name);
    const magnitudes = bandsData.map(band => band.magnitude_db);
    const colors = bandsData.map(band => band.color);
    
    if (appState.charts.bands) {
        // Atualizar gráfico existente
        appState.charts.bands.data.labels = labels;
        appState.charts.bands.data.datasets[0].data = magnitudes;
        appState.charts.bands.data.datasets[0].backgroundColor = colors;
        appState.charts.bands.update('none');
    } else {
        // Criar novo gráfico
        appState.charts.bands = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Magnitude (dB)',
                    data: magnitudes,
                    backgroundColor: colors,
                    borderColor: colors,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        display: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { 
                            color: 'rgba(255, 255, 255, 0.7)',
                            maxRotation: 45
                        }
                    },
                    y: {
                        display: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                    }
                },
                animation: { duration: 300 }
            }
        });
    }
}

function updateBandsList(bandsData) {
    const bandsList = document.getElementById('bands-list');
    if (!bandsList) return;
    
    bandsList.innerHTML = '';
    
    bandsData.forEach(band => {
        const bandItem = document.createElement('div');
        bandItem.className = 'band-item';
        
        bandItem.innerHTML = `
            <div class="band-info">
                <div class="band-name">${band.name}</div>
                <div class="band-range">${band.range}</div>
            </div>
            <div class="band-value">
                <div class="band-magnitude">${band.magnitude_db.toFixed(1)} dB</div>
                <div class="band-color" style="background-color: ${band.color}"></div>
            </div>
        `;
        
        bandsList.appendChild(bandItem);
    });
}

// Gerenciamento de configurações
function loadStoredSettings() {
    // URL do ESP32
    const storedUrl = localStorage.getItem('esp32_url');
    if (storedUrl) {
        document.getElementById('esp32-url').value = storedUrl;
    }
    
    // Taxa de atualização
    const storedRate = localStorage.getItem('refresh_rate');
    if (storedRate) {
        document.getElementById('refresh-rate').value = storedRate;
        appState.refreshRate = parseInt(storedRate);
    }
    
    // Máximo de histórico
    const storedHistory = localStorage.getItem('max_history');
    if (storedHistory) {
        document.getElementById('max-history').value = storedHistory;
        appState.maxHistory = parseInt(storedHistory);
    }
}

function saveSettings() {
    localStorage.setItem('esp32_url', appState.esp32Url);
    localStorage.setItem('refresh_rate', appState.refreshRate.toString());
    localStorage.setItem('max_history', appState.maxHistory.toString());
}

// Utilitários
function showError(message) {
    // Criar elemento de erro se não existir
    let errorDiv = document.querySelector('.error');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        document.querySelector('.main-content').insertBefore(errorDiv, document.querySelector('.main-content').firstChild);
    }
    
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    // Remover após 5 segundos
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

// Limpeza
window.addEventListener('beforeunload', function() {
    if (appState.refreshInterval) {
        clearInterval(appState.refreshInterval);
    }
});

// Log inicial
console.log('🌱 Dashboard carregado');
console.log('Configurações:', CONFIG);
    </script>
</body>
</html>